<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Davamiyyət Cədvəli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .details-cell { cursor: pointer; }
        .details-cell:hover { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Davamiyyət Cədvəli</h1>
            <p class="text-lg text-gray-600 mt-2">Şagirdlərin fənlər üzrə ümumi qayıbları</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div id="attendance-table-container" class="overflow-x-auto">
                <p id="loading-message" class="p-8 text-gray-500 text-center">Məlumatlar yüklənir...</p>
            </div>
        </main>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="modal-title" class="text-xl font-semibold">Qayıb Tarixləri</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <ul id="modal-list-body" class="space-y-2">
                    </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================================
        // SİZİN TƏQDİM ETDİYİNİZ FIREBASE MƏLUMATLARI
        // =======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8",
            authDomain: "davamiyyet-sistemi.firebaseapp.com",
            projectId: "davamiyyet-sistemi",
            storageBucket: "davamiyyet-sistemi.appspot.com",
            messagingSenderId: "773549402059",
            appId: "1:773549402059:web:25286906aa1d998041f84e",
            measurementId: "G-M3Y8QZCM8C"
        };
        // =======================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tableContainer = document.getElementById('attendance-table-container');
        const loadingMessage = document.getElementById('loading-message');
        const modal = document.getElementById('details-modal');
        const closeModalButton = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalListBody = document.getElementById('modal-list-body');
        
        let allAbsences = [];

        // =======================================================================
        // BU SİYAHI ADMIN PANELİNDƏKİ SİYAHI İLƏ EYNİ OLMALIDIR!
        // =======================================================================
        const students = [
          "İsayev Ramal Rəfayıl",
          "Qulamov Kamil Amil",
          "Abbaszadə Salman Məsud",
          "Heydərli Heydər Sabir",
          "Mikayılova Lalə Samir",
          "Seyidov Nurəli Mirnayıb",
          "Kübərov Rahid Mahmud",
          "Bayramov Məmməd Vaqif",
          "Həsənov Mənzər İlqar",
          "Rüstəmov Elgün Ceyhun",
          "Xasayeva Nərmin Azər",
          "İbalı Cəmilə Rəfail",
          "Mirzəyeva Nüşabə Hacıəli",
          "Muradova Leyla Qadir",
          "Əhmədov Kənan Ceyhun",
          "Sultanlı Nihad Sərhad",
          "Əsgərov Elnar Vüsal",
          "Hüseynli Nərgiz Mütəllim",
          "Mirişov Nihad Murad",
          "Ağalizadə Səid Elman",
          "Hüseynova Firuzə Sənan",
          "Ağakərimov Fəqan Alim",
          "Həsənova Cəmalə Sergey",
          "Əliyev Fuad Razim",
          "Orucov Nurlan Seymur",
          "Məhərrəmli Nicat Elxan"
        ];
        // =======================================================================

        const subjects = ["Ehtimal nəzəriyyəsi və statistika", "Sistem proqramlaşdırma", "XDIAK-3", "Verilənlər bazası sistemləri", "Kompüter arxitekturası-1", "Web sistemləri və texnologiyaları"];

        const q = query(collection(db, "qayiblar"), orderBy("tarix", "desc"));
        onSnapshot(q, (querySnapshot) => {
            allAbsences = [];
            querySnapshot.forEach((doc) => {
                allAbsences.push(doc.data());
            });
            updateUI();
        });

        function updateUI() {
            // 1. Məlumatları şagird və fənnə görə qruplaşdır
            const absencesByStudent = {};
            students.forEach(student => {
                absencesByStudent[student] = {};
                subjects.forEach(subject => {
                    absencesByStudent[student][subject] = 0;
                });
            });

            allAbsences.forEach(absence => {
                if (absencesByStudent[absence.usaqAdi] && absencesByStudent[absence.usaqAdi][absence.fenn] !== undefined) {
                    absencesByStudent[absence.usaqAdi][absence.fenn]++;
                }
            });

            // 2. HTML Cədvəlini yarat
            let tableHTML = `
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="py-3 px-6">Ad Soyad</th>`;
            subjects.forEach(subject => {
                tableHTML += `<th scope="col" class="py-3 px-6 text-center">${subject}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            students.forEach(student => {
                tableHTML += `<tr class="bg-white border-b hover:bg-gray-50">
                                <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${student}</td>`;
                subjects.forEach(subject => {
                    const count = absencesByStudent[student][subject];
                    tableHTML += `<td 
                                    class="py-4 px-6 text-center font-bold ${count > 0 ? 'text-red-600 details-cell' : 'text-gray-500'}"
                                    data-student="${student}" 
                                    data-subject="${subject}">
                                    ${count}
                                  </td>`;
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            loadingMessage.style.display = 'none';

            // 3. Klik eventlərini təyin et
            document.querySelectorAll('.details-cell').forEach(cell => {
                if (parseInt(cell.textContent) > 0) {
                    cell.addEventListener('click', () => {
                        const studentName = cell.getAttribute('data-student');
                        const subjectName = cell.getAttribute('data-subject');
                        showDetails(studentName, subjectName);
                    });
                }
            });
        }
        
        function showDetails(student, subject) {
            modalTitle.textContent = `${student} - ${subject}`;
            modalListBody.innerHTML = '';

            const filteredAbsences = allAbsences.filter(a => a.usaqAdi === student && a.fenn === subject);
            
            if (filteredAbsences.length === 0) {
                modalListBody.innerHTML = '<li class="p-3 text-center text-gray-500">Qayıb tapılmadı.</li>';
            } else {
                // Tarixləri düzgün sıralamaq üçün
                filteredAbsences.sort((a, b) => new Date(a.tarix) - new Date(b.tarix));
                
                filteredAbsences.forEach(absence => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-100 p-3 rounded-md text-center';
                    listItem.textContent = absence.tarix;
                    modalListBody.appendChild(listItem);
                });
            }

            modal.classList.remove('hidden');
        }

        // Modalı bağlamaq
        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
