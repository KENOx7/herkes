<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qayıblar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        ::selection { background-color: #3b82f6; color: white; }
        .sticky-col {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        thead .sticky-col {
            background-color: #1f2937;
        }
        tbody tr .sticky-col {
             background-color: #1f2937;
        }
        tbody tr:hover .sticky-col {
             background-color: #374151;
        }
    </style>
</head>
<body class="text-gray-200">
        <header class="p-0 sm:p-0 lg:p-0">
          <div class="bg-gray-800 border-b-4 border-blue-500 text-white font-bold p-4 text-2xl text-center shadow-lg">
            758/ITS
          </div>
          <div class="text-center mb-6 mt-6">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 pb-2">
              Qayıblar
            </h1>
            <button 
              onclick="window.location.href='https://kenox7.github.io/Cedvel/'" 
              class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition-transform transform hover:scale-105 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400">
              Geri
            </button>
          </div>
        </header>
    
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <main class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 overflow-hidden">
            <div id="attendance-table-container" class="overflow-x-auto">
                <p id="loading-message" class="p-8 text-gray-400 text-center text-lg">Məlumatlar yüklənir...</p>
            </div>
        </main>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-sm max-h-[90vh] flex flex-col transform transition-all">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h2 id="modal-title" class="text-xl font-semibold text-gray-200">Qayıb Tarixləri</h2>
                <button id="close-modal" class="text-gray-500 hover:text-white text-3xl transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <ul id="modal-list-body" class="space-y-3">
                    </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8",
            authDomain: "davamiyyet-sistemi.firebaseapp.com",
            projectId: "davamiyyet-sistemi",
            storageBucket: "davamiyyet-sistemi.appspot.com",
            messagingSenderId: "773549402059",
            appId: "1:773549402059:web:25286906aa1d998041f84e",
            measurementId: "G-M3Y8QZCM8C"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tableContainer = document.getElementById('attendance-table-container');
        const loadingMessage = document.getElementById('loading-message');
        const modal = document.getElementById('details-modal');
        const closeModalButton = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalListBody = document.getElementById('modal-list-body');
        let allAbsences = [];
        const students = [
          "İsayev Ramal Rəfayıl",
          "Qulamov Kamil Amil",
          "Abbaszadə Salman Məsud",
          "Heydərli Heydər Sabir",
          "Mikayılova Lalə Samir",
          "Seyidov Nurəli Mirnayıb",
          "Kübərov Rahid Mahmud",
          "Bayramov Məmməd Vaqif",
          "Həsənov Mənzər İlqar",
          "Rüstəmov Elgün Ceyhun",
          "Xasayeva Nərmin Azər",
          "İbalı Cəmilə Rəfail",
          "Mirzəyeva Nüşabə Hacıəli",
          "Muradova Leyla Qadir",
          "Əhmədov Kənan Ceyhun",
          "Sultanlı Nihad Sərhad",
          "Əsgərov Elnar Vüsal",
          "Hüseynli Nərgiz Mütəllim",
          "Mirişov Nihad Murad",
          "Ağalizadə Səid Elman",
          "Hüseynova Firuzə Sənan",
          "Ağakərimov Fəqan Alim",
          "Həsənova Cəmalə Sergey",
          "Əliyev Fuad Razim",
          "Orucov Nurlan Seymur",
          "Məhərrəmli Nicat Elxan"
        ];
        const subjects = ["Ehtimal nəzəriyyəsi və statistika", "Sistem proqramlaşdırma", "XDIAK-3", "Verilənlər bazası sistemləri", "Kompüter arxitekturası-1", "Web sistemləri və texologiyaları"];
        
        const subjectLimits = {
            "Ehtimal nəzəriyyəsi və statistika": 6,
            "Sistem proqramlaşdırma": 6,
            "XDIAK-3": 8,
            "Verilənlər bazası sistemləri": 8,
            "Kompüter arxitekturası-1": 6,
            "Web sistemləri və texologiyaları": 10
        };

        const q = query(collection(db, "qayiblar"), orderBy("tarix", "desc"));
        onSnapshot(q, (querySnapshot) => {
            allAbsences = querySnapshot.docs.map(doc => doc.data());
            updateUI();
        });

        function updateUI() {
            const absencesByStudent = {};
            students.forEach(student => {
                absencesByStudent[student] = {};
                subjects.forEach(subject => {
                    absencesByStudent[student][subject] = 0;
                });
            });

            allAbsences.forEach(absence => {
                if (absencesByStudent[absence.usaqAdi] && absencesByStudent[absence.usaqAdi][absence.fenn] !== undefined) {
                    absencesByStudent[absence.usaqAdi][absence.fenn]++;
                }
            });

            let tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 bg-gray-800">
                        <tr>
                            <th scope="col" class="sticky-col py-4 px-4 font-semibold">Ad Soyad</th>`;
            subjects.forEach(subject => {
                const limit = subjectLimits[subject] || 'N/A';
                
                tableHTML += `<th scope="col" class="py-3 px-3 text-center font-semibold">
                                <div>${subject}</div>
                                <div class="text-yellow-400 font-normal text-xs mt-1">(Limit: ${limit})</div>
                              </th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            students.forEach(student => {
                const shortStudentName = student.split(' ').slice(0, 2).join(' ');

                tableHTML += `<tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors duration-200">
                                    <td class="sticky-col py-4 px-4 font-medium text-gray-200 whitespace-nowrap">${shortStudentName}</td>`;
                subjects.forEach(subject => {
                    const count = absencesByStudent[student][subject];
                    const limit = subjectLimits[subject];
                    
                    let countColor = 'text-gray-500'; 
                    if (count > 0 && limit) {
                        if (count >= limit) {
                            countColor = 'text-red-500 font-extrabold animate-pulse';
                        } else {
                            const percentage = count / limit;
                            if (percentage >= 0.75) {
                                countColor = 'text-orange-500 font-bold';
                            } else {
                                countColor = 'text-yellow-400';
                            }
                        }
                    } else if (count > 0) {
                        countColor = 'text-yellow-400';
                    }
                    
                    const isClickable = count > 0 ? 'cursor-pointer' : '';

                    tableHTML += `<td 
                                    class="py-4 px-2 text-center font-bold text-lg ${countColor} ${isClickable}"
                                    data-student="${student}" 
                                    data-subject="${subject}">
                                    ${count}
                                  </td>`;
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            loadingMessage.style.display = 'none';

            tableContainer.querySelectorAll('td[data-student]').forEach(cell => {
                if (parseInt(cell.textContent) > 0) {
                    cell.addEventListener('click', () => {
                        const studentName = cell.getAttribute('data-student');
                        const subjectName = cell.getAttribute('data-subject');
                        showDetails(studentName, subjectName);
                    });
                }
            });
        }
        
        function showDetails(student, subject) {
            modalTitle.textContent = `${student} - ${subject}`;
            modalListBody.innerHTML = '';

            const filteredAbsences = allAbsences
                .filter(a => a.usaqAdi === student && a.fenn === subject)
                .sort((a, b) => new Date(a.tarix) - new Date(b.tarix));
            
            if (filteredAbsences.length === 0) {
                modalListBody.innerHTML = '<li class="p-3 text-center text-gray-400">Qayıb tapılmadı.</li>';
            } else {
                filteredAbsences.forEach(absence => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-700 p-3 rounded-lg text-center font-mono text-blue-300';
                    listItem.textContent = absence.tarix;
                    modalListBody.appendChild(listItem);
                });
            }
            modal.classList.remove('hidden');
        }

        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });
    </script>
</body>
</html>
